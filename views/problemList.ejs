<!DOCTYPE html>
<html>
<head>
  <title>Patient Page</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
  integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
  crossorigin="anonymous"></script>
  <script type="text/javascript" src="/files/js/stickyfillmin.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.3.0/js/bootstrap-datepicker.js"></script>
  <script type="text/javascript" src="/files/js/pageScript.js"></script>

  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Nunito"/>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
  integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <link rel="stylesheet" type="text/css" href="/files/css/views.css">
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.3.0/css/datepicker.css" rel="stylesheet" type="text/css" />
</head>
<body> 
  <div class="background">
    <div class="sidebarContainer">
      <div class="row">
        <nav class="col-sm-2 sidebar">
          <div class = "sidebar sticky " >
            <div class = "basicInfo"> 
              <h2 id = "name"><%= data.firstName%> <%= data.lastName%></h2>
              <br>
              <p id="ageSex"> (Age) 19, <%=data.sex%></p>
              <p id="dob"><%= data.birthdate%> </p>
              <p id="weightHeight"> <%= data.weight%> kg, <%= data.height%> cm </p>
              <p id="allergiesSide"> Allergies: (loop patient.allergies[i]) </p>
            </div>
            <ul class="nav nav-pills nav-stacked links">
              <li class="active current"><a href='/patientPage/<%=data.id%>'>Patient Summary</a></li>
              <li><a href="/patientPage/<%=data.id%>/history">Information &amp; History </a></li>
              <li><a href="/patientPage/<%=data.id%>/problemList">Problem List</a></li>
              <li><a href="/patientPage/<%=data.id%>/medications">Medication List</a></li>
              <li><a href="/patientPage/<%=data.id%>/immunization">Immunization Record</a></li>
              <li><a href="/patientPage/<%=data.id%>/allergies">Allergies</a></li>
              <li><a href="/patientPage/<%=data.id%>/wellChildCheck">Well Child Check Page</a></li>
              <li><a href="/patientPage/<%=data.id%>/wellChildCheckForm">Well Child Check Form</a></li>
              <li><a href="/patientPage/<%=data.id%>/testing">Testing</a></li>
              <li><a href="/patientPage/<%=data.id%>/growthCharts">Growth Charts</a></li>
              <li><a href="#section7">Nurse Notes</a></li>
              <li><a href="#section8">Scans</a></li>
            </ul>
          </div>
        </nav>
        <div class="col-lg">   
          <div class = "card header">
           <div class = "topRight">
            <a> Welcome, "*User Name*"  | </a>
            <a href="/" class="btn btn-outline-success"> Logout </a>
          </div>
          <div>
            <a href="/patientSearch" style="text-decoration : none "> <p class = "label" id = "R-plus"> R+ </p>
            <p class = "label" id = "Childrens">Childrens</p> </a>
            <a href="#Pharmacy" class = "top-nav" id = "pharmacy">Pharmacy</a>
            <a href="#AllPatients" class = "top-nav" id = "rec-pat">Recent Patients</a>
            <a href="/patientSearch" class = "top-nav" id = "search-pat">Search Patients</a>
            <a href="/form" class = "top-nav" id = "search-pat">Add Patient</a>
          </div>
        </div>
        <div class = "content-container">
         <div class = "card box summary">
          <h3 class="title"> Problem List </h3>
        </div>
      </div>

      <div id="chronicProb" class="box card section">
        <table class="w3-table-all">
          <div class="subTitle">
           Chronic Problems 
         </div>
         <thead>
          <tr class="w3-light-grey">
            <th>Diagnosis</th>
            <th>Details</th>
            <th>Treatment</th>
            <th>Date of Onset</th>
            <th>Date of Resolution</th>
            <th class="edit">Edit</th>
          </tr>
        </thead>
        <tbody id="chronicTableBody" >
        </tbody>
      </table>
      <form id="chronicForm" class="tr addForm collapse">
          <span class="td"><input type="text" name="chronicDiagnosis" placeholder="Diagnosis"></span>
          <span class="td"><input type="text" name="chronicDetails" placeholder="Details"></span>
          <span class="td"><input type="text" name="chronicTreatment" placeholder="Treatment"></span>
          <span class="td"><input type="text" name="chronicOnset" class="datepicker form-control" ></span>
          <span class="td"><input type="text" name="chronicResolution" placeholder="Resolution"></span>
          <input type="submit" value="Submit" id="chronicSubmit" name="chronicSubmit" class="btn btn-primary formSubmit">
          <input type="button" value="Cancel" name="cancel" class="btn btn-danger formSubmit cancel" data-toggle="collapse" data-target="#chronicForm">
      </form>
      <div>                               
        <button id="addChronicProb" class="add" data-toggle="collapse" data-target="#chronicForm" aria-expanded="false" aria-controls="collapseExample"> + </button>
      </div>
    </div>

    <div id="acuteProb" class="box card section">
      <table class="w3-table-all">
        <div class="subTitle">
         Acute Problems 
       </div>
       <thead>
        <tr class="w3-light-grey">
          <th>Diagnosis</th>
          <th>Details</th>
          <th>Treatment</th>
          <th>Date of Onset</th>
          <th>Date of Resolution</th>
          <th class="edit">Edit</th>
        </tr>
      </thead>
      <tbody id="acuteTableBody" >
      </tbody>
    </table>
    <form id="acuteForm" class="tr addForm collapse">
      <span class="td"><input type="text" name="acuteDiagnosis" placeholder="Diagnosis"></span>
      <span class="td"><input type="text" name="acuteDetails" placeholder="Details"></span>
      <span class="td"><input type="text" name="acuteTreatment" placeholder="Treatment"></span>
      <span class="td"><input type="text" name="acuteOnset" class="datepicker form-control" ></span>
      <span class="td"><input type="text" name="acuteResolution" placeholder="Resolution"></span>
      <input type="submit" value="Submit" id="acuteSubmit" name="acuteSubmit" class="btn btn-primary formSubmit">
      <input type="button" value="Cancel" name="cancel" class="btn btn-danger formSubmit cancel">
    </form>
    <div>                               
      <button id="addAcuteProb" class="add" data-toggle="collapse" data-target="#acuteForm" aria-expanded="false" aria-controls="collapseExample"> + </button>
    </div>
  </div>
</div>
</body>
<script type="text/javascript">
  var patientId = <%=data.id%>;
  $('document').ready(function() {
    console.log("document.ready ajax call: ");
      // // ajax call to render the original table, where we post to getAllWeights
      // // we return a JSON in which we call updateTable with 
       $.ajax({
           type: "POST",
           url: "/getAllChronic",
           data : {
             id: patientId
           },
           success: function(data) {
             console.log(data);
             if(data.data.length != 0){
              updateTableChronic(data.data[0].chronicEntries);
             }
           }
       });
       $.ajax({
           type: "POST",
           url: "/getAllAcute",
           data : {
             id: patientId
           },
           success: function(data) {
             console.log(data);
             if(data.data.length != 0){
              updateTableAcute(data.data[0].acuteEntries);
             }
           }
       });
      // ajax call that on submit will send the new chronic problem values to the database
      $('#chronicSubmit').click(function(e) {
        e.preventDefault();
        var input = $("#chronicForm").serializeArray();
        console.log("got here: ");
        console.log(input);
        $.ajax({
            type: "POST",
            url: "/chronicProblem",
            data : {
              id: patientId, 
              chronicDiagnosis: input[0].value,
              chronicDetails: input[1].value, 
              chronicTreatment: input[2].value,
              chronicDateOnset: input[3].value,  
              chronicEndDate: input[4].value,  
            },
            success: function(data) {
              console.log("New chronic data: ");
              console.log(data);
              updateTableChronic(data.data[0].chronicEntries);
            }
        });
      });
      $('#acuteSubmit').click(function(e) {
        e.preventDefault();
        var input = $("#acuteForm").serializeArray();
        console.log("got here: ");
        console.log(input);
        $.ajax({
            type: "POST",
            url: "/acuteProblem",
            data : {
              id: patientId, 
              acuteDiagnosis: input[0].value,
              acuteDetails: input[1].value, 
              acuteTreatment: input[2].value,
              acuteDateOnset: input[3].value,  
              acuteEndDate: input[4].value,  
            },
            success: function(data) {
              console.log("New chronic data: ");
              console.log(data);
              updateTableAcute(data.data[0].acuteEntries);
            }
        });
      });
  });
  
  // function that takes in JSON with two fields: height and date and renders the table as such
  var updateTableChronic = function(data) {
       console.log(data);
       var table1 = '';
       for(var i = 0; i < data.length; i++) {
           var line = '<tr><td>' +  data[i].chronicDiagnosis + '</td>';
           line += '<td>' + data[i].chronicDetails + '</td>';
           line += '<td>' + data[i].chronicTreatment + '</td>';
           line += '<td>' + data[i].chronicDateOnset + '</td>';
           line += '<td>' + data[i].chronicEndDate + '</td>';
           line += '<td><button class="editBtn btn">Edit</button></td></tr>';
           table1 += line;
       }
       document.getElementById('chronicTableBody').innerHTML = table1;
  };
  var updateTableAcute = function(data) {
       console.log(data);
       var table1 = '';
       for(var i = 0; i < data.length; i++) {
           var line = '<tr><td>' +  data[i].acuteDiagnosis + '</td>';
           line += '<td>' + data[i].acuteDetails + '</td>';
           line += '<td>' + data[i].acuteTreatment + '</td>';
           line += '<td>' + data[i].acuteDateOnset + '</td>';
           line += '<td>' + data[i].acuteEndDate + '</td>';
           line += '<td><button class="editBtn btn">Edit</button></td></tr>';
           table1 += line;
       }
       document.getElementById('acuteTableBody').innerHTML = table1;
  };

  </script>
</html>
